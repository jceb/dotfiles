#!/usr/bin/env -S nu

# Create a backup using kopia
def main [] {
  let backup_dir = "/mnt/data"
  let rootfs_dir = "/mnt/rootfs"
  print "Mounting directories"
  sudo mount /dev/mapper/system $rootfs_dir
  let latest_snapshot = ls -l $"($rootfs_dir)/timeshift-btrfs/snapshots" | last
  print $"Using snapshot ($latest_snapshot.name)"
  sudo mount --bind $"($latest_snapshot.name)/@home" $backup_dir
  print "Creating backup"
  kopia snapshot create ...([Backup Documents Seafile] | each {[$backup_dir jceb $in] | path join})
  print "Unmounting directories"
  sudo umount $backup_dir
  sudo umount $rootfs_dir
}
